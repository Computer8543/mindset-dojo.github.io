{%- comment -%}
authors-grid.html
──────────────────
Purpose:
  Render a grid of active authors and (optionally) a wrapper/heading.

Parameters:
  - leadership_flow (optional): map with at least `label`; may include `limit`
  - profiles?  (optional): override data source
  - avatars?   (optional): override data source
  - designation_type? (optional): filter authors who have a non-empty
      leadership designation of this type (e.g., "program", "project")

Data Source (defaults):
  site.data.authors.profiles
  site.data.authors.avatars

Sort:
  1) belt_level DESC (higher first)
  2) belt_level_date ASC (earlier first; falls back to join_date, then to "9999-12-31")

Limit:
  If leadership_flow.limit is set, only render up to that many authors.
{%- endcomment -%}

{%- assign profiles = include.profiles | default: site.data.authors.profiles -%}
{%- assign avatars  = include.avatars  | default: site.data.authors.avatars  -%}
{%- assign entries  = "" | split: "|" -%}

{%- assign has_wrapper = include.leadership_flow -%}
{%- if has_wrapper -%}
<section class="md-flow">
  {%- if include.leadership_flow.label -%}
    <h2>{{ include.leadership_flow.label }}</h2>
  {%- endif -%}
</section>
{%- endif -%}

<div class="md-authors">
  {%- comment -%} 1) Build sortable list of active (optionally filtered) authors {%- endcomment -%}
  {% for pair in profiles %}
    {% assign key = pair[0] %}
    {% assign author = pair[1] %}

    {%- assign show_author = author.active -%}

    {%- if show_author and include.designation_type -%}
      {%- assign dt = include.designation_type | downcase | strip -%}
      {%- assign show_author = false -%}
      {%- assign ld = author.leadership_designations -%}
      {%- if ld and ld.size > 0 -%}
        {%- for item in ld -%}
          {%- assign t = item.type  | downcase | strip -%}
          {%- assign v = item.value | default: item.key | to_s | strip -%}
          {%- if t == dt and v != "" and v != "null" -%}
            {%- assign show_author = true -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endif -%}

    {% if show_author %}
      {%- comment -%}
        belt_level DESC → negate, pad, and sort ASC
        date ASC → use belt_level_date, fall back to join_date, else far future to push to end
      {%- endcomment -%}
      {%- assign neg_belt = author.belt_level | times: -1 | plus: 1000 | prepend: "0000" | slice: -4, 4 -%}
      {%- assign bld = author.belt_level_date | default: author.join_date | default: "9999-12-31" -%}
      {% capture entry %}{{ neg_belt }}|{{ bld }}|{{ key }}{% endcapture %}
      {% assign entries = entries | push: entry %}
    {% endif %}
  {% endfor %}

  {%- comment -%} 2) Sort by belt_level DESC (via neg_belt), then belt_level_date ASC {%- endcomment -%}
  {% assign sorted_entries = entries | sort %}

  {%- comment -%} 3) Respect optional limit from leadership_flow.limit {%- endcomment -%}
  {%- assign render_entries = sorted_entries -%}
  {%- if include.leadership_flow and include.leadership_flow.limit -%}
    {%- assign lim = include.leadership_flow.limit | plus: 0 -%}
    {%- if lim > 0 and render_entries.size > lim -%}
      {%- assign render_entries = render_entries | slice: 0, lim -%}
    {%- endif -%}
  {%- endif -%}

  {%- comment -%} 4) Render each profile card {%- endcomment -%}
  {% for entry in render_entries %}
    {% assign parts  = entry | split: "|" %}
    {% assign key    = parts[2] %}
    {% assign author = profiles[key] %}
    {% assign avatar = avatars[key] %}
    {% include author.html author=author avatar=avatar %}
  {% endfor %}
</div>
