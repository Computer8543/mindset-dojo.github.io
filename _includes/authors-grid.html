{%- comment -%}
authors-grid.html
──────────────────
Purpose:
  Render a grid of active authors and potentially an introduction title

Parameters:
  - leadership_flow (optional): map with at least `label`
  - profiles?  (optional): override data source
  - avatars?   (optional): override data source
  - designation_type? (optional): filter authors who have a non-empty
      leadership designation of this type (e.g., "program", "project")

Data Source (defaults):
  site.data.authors.profiles
  site.data.authors.avatars

Usage:
  {% include authors-grid.html %}  <!-- grid only -->
  {% include authors-grid.html leadership_flow=context.leadership_flow %}
  {% include authors-grid.html designation_type="project" %}
{%- endcomment -%}

{%- assign profiles = include.profiles | default: site.data.authors.profiles -%}
{%- assign avatars  = include.avatars  | default: site.data.authors.avatars  -%}
{%- assign entries  = "" | split: "|" -%}

{%- assign has_wrapper = include.leadership_flow -%}
{%- if has_wrapper -%}
<section class="md-flow">
  {%- if include.leadership_flow.label -%}
    <h2>{{ include.leadership_flow.label }}</h2>
  {%- endif -%}
</section>
{%- endif -%}

<div class="md-authors">
  {%- comment -%} 1) Build sortable list of active (optionally filtered) authors {%- endcomment -%}
  {% for pair in profiles %}
    {% assign key = pair[0] %}
    {% assign author = pair[1] %}

    {%- assign show_author = author.active -%}

    {%- if show_author and include.designation_type -%}
      {%- assign dt = include.designation_type | downcase | strip -%}
      {%- assign show_author = false -%}
      {%- assign ld = author.leadership_designations -%}

      {%- if ld and ld.size > 0 -%}
        {%- for item in ld -%}
          {%- assign t = item.type  | downcase | strip -%}
          {%- assign v = item.value | default: item.key | to_s | strip -%}
          {%- if t == dt and v != "" and v != "null" -%}
            {%- assign show_author = true -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endif -%}

    {% if show_author %}
      {%- assign neg_belt = author.belt_level | times: -1 | plus: 1000 | prepend: "0000" | slice: -4, 4 -%}
      {% capture entry %}{{ neg_belt }}|{{ author.join_date }}|{{ key }}{% endcapture %}
      {% assign entries = entries | push: entry %}
    {% endif %}
  {% endfor %}

  {%- comment -%} 2) Sort by belt_level DESC, then join_date ASC {%- endcomment -%}
  {% assign sorted_entries = entries | sort %}

  {%- comment -%} 3) Render each profile card {%- endcomment -%}
  {% for entry in sorted_entries %}
    {% assign parts  = entry | split: "|" %}
    {% assign key    = parts[2] %}
    {% assign author = profiles[key] %}
    {% assign avatar = avatars[key] %}
    {% include author.html author=author avatar=avatar %}
  {% endfor %}
</div>
