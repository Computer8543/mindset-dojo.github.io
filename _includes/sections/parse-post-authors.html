{%- comment -%}
Minimal parse-post-authors include with explicit array support.
Accepts: include.p_auth, include.authors, include.data.authors, include.section.data.authors
Emits: CSV of slugified author slugs (e.g. "kyle-ingersoll,michael-basil")
{%- endcomment -%}

{%- assign resolved = "" -%}

{%- if include.p_auth != nil -%}
  {%- assign resolved = include.p_auth -%}
{%- elsif include.authors != nil -%}
  {%- assign resolved = include.authors -%}
{%- elsif include.data != nil and include.data.authors != nil -%}
  {%- assign resolved = include.data.authors -%}
{%- elsif include.section != nil and include.section.data != nil and include.section.data.authors != nil -%}
  {%- assign resolved = include.section.data.authors -%}
{%- endif -%}

{%- if resolved == nil -%}{%- assign resolved = "" -%}{%- endif -%}

{%- assign tokens = "" | split: "|" -%}

{%- comment -%}
If the caller passed an array (e.g. p_auth is an array), handle it directly.
This avoids any brittle stringify/json checks for the common case.
{%- endcomment -%}
{%- if include.p_auth != nil and include.p_auth[0] != nil -%}
  {%- assign tokens = include.p_auth -%}
{%- elsif include.authors != nil and include.authors[0] != nil -%}
  {%- assign tokens = include.authors -%}
{%- else -%}
  {%- if resolved != "" -%}
    {%- assign jsoned = resolved | jsonify -%}

    {%- if jsoned contains '[' and jsoned contains ']' -%}
      {%- assign inner = jsoned | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
      {%- if inner != "" -%}
        {%- assign tokens = inner | split:',' | map:'strip' -%}
      {%- endif -%}

    {%- elsif jsoned contains ',' -%}
      {%- assign tmp = jsoned | remove:'"' | remove:"'" | strip -%}
      {%- assign tokens = tmp | split:',' | map:'strip' -%}

    {%- elsif jsoned contains '\n' -%}
      {%- assign tmp = jsoned | remove:'"' | remove:"'" | strip -%}
      {%- assign tokens = tmp | split:'\n' | map:'strip' -%}

    {%- else -%}
      {%- assign tmp = jsoned | remove:'"' | remove:"'" | strip -%}
      {%- if tmp != "" -%}{%- assign tokens = tokens | push: tmp -%}{%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%}
Fallback: if tokens empty but resolved non-empty, try substring match against known author slugs
(helps with concatenated tokens).
{%- endcomment -%}
{%- if (tokens == "" or tokens.size == 0) and resolved != "" -%}
  {%- assign resolved_str = resolved | jsonify | remove:'"' | remove:"'" | strip -%}
  {%- for a in site.authors -%}
    {%- assign s = a.slug | slugify -%}
    {%- if s != "" and resolved_str contains s -%}
      {%- assign tokens = tokens | push: s -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- comment -%} Emit CSV of slugified tokens {%- endcomment -%}
{%- assign out_first = true -%}
{%- for t in tokens -%}
  {%- assign t_slug = t | split:'.' | first | slugify | strip -%}
  {%- if t_slug != "" -%}
    {%- if out_first -%}
{{ t_slug }}{%- assign out_first = false -%}
    {%- else -%}
,{{ t_slug }}{%- endif -%}
  {%- endif -%}
{%- endfor -%}
