{%- comment -%}
Robust parse-post-authors include.
Accepts include.p_auth / include.p_authors / include.authors / include.p (post).
Emits CSV of normalized slugs.
Also: if parsing fails (e.g. "michael-basilkyle-ingersoll"), it will search known
site.author slugs inside the raw string and return any matches.
{%- endcomment -%}

{%- assign resolved = nil -%}
{%- if include.p_auth != nil -%}
  {%- assign resolved = include.p_auth -%}
{%- elsif include.p_authors != nil -%}
  {%- assign resolved = include.p_authors -%}
{%- elsif include.authors != nil -%}
  {%- assign resolved = include.authors -%}
{%- elsif include.p != nil -%}
  {%- if include.p.authors != nil -%}
    {%- assign resolved = include.p.authors -%}
  {%- elsif include.p.author != nil -%}
    {%- assign resolved = include.p.author -%}
  {%- elsif include.p.auth != nil -%}
    {%- assign resolved = include.p.auth -%}
  {%- endif -%}
{%- endif -%}

{%- if resolved == nil -%}
  {%- assign resolved = "" -%}
{%- endif -%}

{%- assign p_slugs_raw = "" | split: "|" -%}

{%- if resolved != "" -%}
  {%- if resolved[0] != nil -%}
    {%- assign p_slugs_raw = resolved -%}
  {%- else -%}
    {%- assign p_json = resolved | jsonify -%}

    {%- if p_json contains '[' and p_json contains ']' -%}
      {%- assign tmp = p_json | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
      {%- if tmp != "" -%}
        {%- assign p_slugs_raw = tmp | split:',' | map:'strip' -%}
      {%- endif -%}

    {%- elsif p_json contains ',' -%}
      {%- assign tmp = p_json | remove:'"' | remove:"'" | strip -%}
      {%- assign p_slugs_raw = tmp | split:',' | map:'strip' -%}

    {%- else -%}
      {%- assign tmp = p_json | remove:'"' | remove:"'" | strip -%}
      {%- if tmp != "" -%}
        {%- assign p_slugs_raw = tmp | split:'\n' | map:'strip' -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%}
If parsing found nothing useful but we have a non-empty resolved string,
try substring-matching known site.author slugs (handles concatenated slugs).
{%- endcomment -%}
{%- assign fallback_candidates = "" | split: "|" -%}
{%- if p_slugs_raw == "" or p_slugs_raw.size == 0 -%}
  {%- if resolved != "" -%}
    {%- assign resolved_str = resolved | jsonify | remove:'"' | remove:"'" | strip -%}
    {%- for a in site.authors -%}
      {%- assign candidate_slug = a.slug | slugify -%}
      {%- if resolved_str contains candidate_slug -%}
        {%- assign fallback_candidates = fallback_candidates | push: candidate_slug -%}
      {%- endif -%}
    {%- endfor -%}
    {%- if fallback_candidates != "" and fallback_candidates.size > 0 -%}
      {%- assign p_slugs_raw = fallback_candidates -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} Normalize and emit CSV {%- endcomment -%}
{%- assign first_out = true -%}
{%- for ps in p_slugs_raw -%}
  {%- assign ps_norm = ps | split:'.' | first | slugify -%}
  {%- if ps_norm != "" -%}
    {%- if first_out -%}
{{ ps_norm }}{%- assign first_out = false -%}
    {%- else -%}
,{{ ps_norm }}{%- endif -%}
  {%- endif -%}
{%- endfor -%}
