{%- comment -%}
  Renders a stream of collection items with optional filtering, sorting, and limiting.

  Parameters:
    collection: The name of the collection to render items from (required).
    filter_key: The key in the document front matter to filter by (optional).
    filter_values: An array of values to filter the documents by (optional).
    sort_by: The key to sort the documents by (optional).
    reverse: Boolean to indicate if the sorted documents should be reversed (optional).
    excerpt_length: Length of the excerpt to display for each item (optional).
    post_display_limit: Maximum number of items to display (optional).
{%- endcomment -%}

{%- assign coll = site[include.collection] | default: site.collections[include.collection].docs -%}

{%- assign filtered_coll = "" | split: "" -%}
{%- assign key = include.filter_key -%}
{%- assign vals = include.filter_values | array -%}

{%- for doc in coll -%}
  {%- assign field = doc[key] -%}

  {%- comment -%} fallback for forms: derive slug if front matter missing {%- endcomment -%}
  {%- if field == nil and key == "forms" -%}
    {%- assign filename = doc.path | split: "/" | last -%}
    {%- assign slug = filename | split: "." | first -%}
    {%- assign field = slug | split: "|" -%}
  {%- endif -%}

  {%- assign field_arr = field | array -%}
  {%- assign intersect = field_arr | where_exp: "f", "vals contains f" -%}

  {%- if intersect != empty -%}
    {%- assign filtered_coll = filtered_coll | push: doc -%}
  {%- endif -%}
{%- endfor -%}


{%- assign sorted = filtered_coll -%}
{%- if include.sort_by -%}
  {%- assign sorted = sorted | sort: include.sort_by -%}
{%- endif -%}
{%- if include.reverse -%}
  {%- assign sorted = sorted | reverse -%}
{%- endif -%}

{%- for item in sorted limit: include.post_display_limit -%}
  {%- include sections/collection-item.html item=item excerpt_length=include.excerpt_length -%}
{%- endfor -%}
