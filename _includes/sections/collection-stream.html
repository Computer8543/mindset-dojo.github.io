{%- comment -%}
Renders a stream of collection items with optional single-key filtering, sorting, and limiting.

Parameters:
  collection: collection name (include.collection or section.data.collection)
  filter_key: front-matter key to filter by (optional)
  filter_values: array or scalar of filter values (optional)
  sort_by: key to sort by (include.sort_by or section.data.sort_by)
  reverse: boolean to reverse results (include.reverse or section.data.reverse)
  excerpt_length: passed to collection-item include
  post_display_limit: max items to show
{%- endcomment -%}

{%- assign coll_name = include.collection | default: section.data.collection -%}

{%- comment -%} obtain posts array robustly {%- endcomment -%}
{%- assign posts = site[coll_name] -%}
{%- if posts == nil or posts == empty -%}
  {%- assign coll_obj = site.collections[coll_name] -%}
  {%- if coll_obj and coll_obj.docs -%}
    {%- assign posts = coll_obj.docs -%}
  {%- else -%}
    {%- assign posts = "" -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} filter inputs (single-key mode) {%- endcomment -%}
{%- assign keyname = include.filter_key | default: nil -%}
{%- assign fv = include.filter_values | default: nil -%}
{%- if fv -%}
  {%- assign fv = fv | array -%}
{%- endif -%}

{%- comment -%} build filtered_posts: preserve Document objects {%- endcomment -%}
{%- assign filtered_posts = posts | slice: 0, 0 -%} {# empty array #}

{%- if posts and posts != empty -%}
  {%- for post in posts -%}
    {%- assign keep = true -%}

    {%- if keyname and fv and fv != empty -%}
      {%- comment -%} get the post's values for the key (normalize to array) {%- endcomment -%}
      {%- assign post_values = post[keyname] -%}

      {%- if post_values == nil and keyname == "forms" -%}
        {%- assign filename = post.path | split:"/" | last -%}
        {%- assign slug = filename | split:"." | first -%}
        {%- assign post_values = slug | split:"|" -%}
      {%- endif -%}

      {%- assign post_values = post_values | array -%}

      {%- comment -%} check for any intersection between fv and post_values {%- endcomment -%}
      {%- assign matched = false -%}
      {%- for v in post_values -%}
        {%- if fv contains v -%}
          {%- assign matched = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if matched == false -%}
        {%- assign keep = false -%}
      {%- endif -%}
    {%- endif -%}

    {%- if keep -%}
      {%- assign filtered_posts = filtered_posts | push: post -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- comment -%} sorting / reversing / limiting {%- endcomment -%}
{%- assign sort_key_field = include.sort_by | default: section.data.sort_by | default: "date" -%}
{%- assign reverse_flag = include.reverse | default: section.data.reverse | default: false -%}
{%- assign post_display_limit = include.post_display_limit | default: section.data.post_display_limit | default: nil -%}

{%- assign filtered_posts = filtered_posts | sort: sort_key_field -%}
{%- if reverse_flag -%}
  {%- assign filtered_posts = filtered_posts | reverse -%}
{%- endif -%}
{%- if post_display_limit -%}
  {%- assign filtered_posts = filtered_posts | slice: 0, post_display_limit -%}
{%- endif -%}

<section id="collection-stream" class="md-flow">
  {%- for post in filtered_posts -%}
    {% include sections/collection-item.html post=post excerpt_length=include.excerpt_length %}
  {%- endfor -%}
</section>
