{%- comment -%}
DRY collection-stream.html with generic filters
- section.data.collection or include.collection
- section.data.filters or include.filters
- section.data.sort_by (default "date")
- section.data.reverse (boolean)
- section.data.excerpt_length (optional)
- section.data.post_display_limit (optional)
- Any key in filters hash: array of values; posts must match at least one value
{%- endcomment -%}

{%- assign coll_name = include.collection | default: section.data.collection -%}
{%- assign posts = site[coll_name] -%}

{%- assign filters = include.filters | default: {} -%}
{%- assign sort_key_field = section.data.sort_by | default:"date" -%}
{%- assign reverse_flag = section.data.reverse == true -%}

{%- assign filtered_posts = "" | split:"|" -%}

{%- for p in posts -%}
  {%- assign keep = true -%}

  {%- comment -%} Generic filter loop {%- endcomment -%}
  {%- for filter_key in filters -%}
    {%- assign allowed_values = filters[filter_key] -%}
    {%- assign match_found = false -%}

    {%- if p[filter_key] -%}
      {%- for val in p[filter_key] -%}
        {%- if allowed_values contains val -%}
          {%- assign match_found = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      {%- comment -%} Special case: derive slug from filename (slug.md) for forms or similar keys {%- endcomment -%}
      {%- assign filename = p.path | split:"/" | last -%}
      {%- assign slug = filename | split:"." | first -%}
      {%- if allowed_values contains slug -%}
        {%- assign match_found = true -%}
      {%- endif -%}
    {%- endif -%}

    {%- if match_found == false -%}
      {%- assign keep = false -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if keep -%}
    {%- assign filtered_posts = filtered_posts | push: p -%}
  {%- endif -%}
{%- endfor -%}

{%- assign filtered_posts = filtered_posts | sort: sort_key_field -%}
{%- if reverse_flag -%}{%- assign filtered_posts = filtered_posts | reverse -%}{%- endif -%}
{%- if section.data.post_display_limit -%}
  {%- assign filtered_posts = filtered_posts | slice: 0, section.data.post_display_limit -%}
{%- endif -%}

<section id="collection-stream" class="md-flow">
  {%- for post in filtered_posts -%}
    {% include sections/collection-item.html
       post=post
       excerpt_length=section.data.excerpt_length
    %}
  {%- endfor -%}
</section>
