{%- comment -%}
Generic collection-stream with a small generic filter loop.
- collection: include.collection OR section.data.collection
- filters: include.filters OR section.data.filters (hash). Values may be string or array.
- sort_by / reverse / post_display_limit / excerpt_length supported.
{%- endcomment -%}

{%- assign coll_name = include.collection | default: section.data.collection -%}
{%- assign posts = site[coll_name] | default: "" -%}

{%- comment -%} normalize filters into a proper hash/object {%- endcomment -%}
{%- assign filters = include.filters | default: section.data.filters | default: {} -%}
{%- if filters == nil or filters == "" -%}
  {%- assign filters = {} -%}
{%- endif -%}

{%- assign sort_key_field = section.data.sort_by | default: "date" -%}
{%- assign reverse_flag = section.data.reverse == true -%}
{%- assign display_limit = include.post_display_limit | default: section.data.post_display_limit -%}

{%- assign filtered_posts = "" | split: "|" -%}

{%- for p in posts -%}
  {%- assign keep = true -%}

  {%- for filter_key in filters -%}
    {%- assign raw_vals = filters[filter_key] -%}
    {%- assign filter_values = raw_vals | array -%} {# coerce to array #}

    {%- if filter_values == nil or filter_values == empty -%}
      {%- continue -%} {# skip empty filter values #}
    {%- endif -%}

    {%- comment -%} Case A: post exposes the field named after the filter_key {%- endcomment -%}
    {%- if p[filter_key] -%}
      {%- assign post_vals = p[filter_key] | array -%}
      {%- assign matched = false -%}
      {%- for pv in post_vals -%}
        {%- assign pv_norm = pv | strip -%}
        {%- for fv in filter_values -%}
          {%- assign fv_norm = fv | strip -%}
          {%- if pv_norm == fv_norm -%}
            {%- assign matched = true -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if matched -%}{%- break -%}{%- endif -%}
      {%- endfor -%}
      {%- if matched == false -%}
        {%- assign keep = false -%}
      {%- endif -%}

    {%- comment -%} Case B: post lacks the field but filter_key == this collection: match by filename slug (slug.md) {%- endcomment -%}
    {%- elsif filter_key == coll_name and p.path -%}
      {%- assign filename = p.path | split:"/" | last -%}
      {%- assign slug = filename | split:"." | first | strip -%}
      {%- assign match = false -%}
      {%- for fv in filter_values -%}
        {%- if slug == (fv | strip) -%}
          {%- assign match = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
      {%- unless match -%}
        {%- assign keep = false -%}
      {%- endunless -%}

    {%- comment -%} Case C: no match possible -> fail this post for this filter key {%- endcomment -%}
    {%- else -%}
      {%- assign keep = false -%}
    {%- endif -%}

    {%- if keep == false -%}{%- break -%}{%- endif -%}
  {%- endfor -%}

  {%- if keep -%}
    {%- assign filtered_posts = filtered_posts | push: p -%}
  {%- endif -%}
{%- endfor -%}

{%- assign filtered_posts = filtered_posts | sort: sort_key_field -%}
{%- if reverse_flag -%}{%- assign filtered_posts = filtered_posts | reverse -%}{%- endif -%}
{%- if display_limit -%}{%- assign filtered_posts = filtered_posts | slice: 0, display_limit -%}{%- endif -%}

<section id="collection-stream" class="md-flow">
  {%- for post in filtered_posts -%}
    {% include sections/collection-item.html post=post excerpt_length=section.data.excerpt_length %}
  {%- endfor -%}
</section>
