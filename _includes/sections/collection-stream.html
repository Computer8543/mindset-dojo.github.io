{%- comment -%}
DRY sequential-flow collection-stream.html with authors + forms filtering
- section.data.collection
- section.data.sort_by (default "date")
- section.data.reverse (boolean)
- section.data.excerpt_length (optional)
- section.data.authors OR include.authors: YAML array of author slugs
- section.data.forms OR include.forms: YAML array of form slugs
- section.data.post_display_limit (optional)
- page.slug fallback for override authors
- p.authors: YAML array
- p.forms: YAML array (optional)
- Optional author + form filtering applied inline
- Slug extraction for forms is now just the filename without .md
{%- endcomment -%}

{%- assign coll_name = section.data.collection -%}
{%- assign posts = site[coll_name] -%}

{%- assign override_authors = include.authors | default: section.data.authors -%}
{%- if override_authors == nil and page and page.slug -%}
  {%- assign override_authors = page.slug | split:"|" -%}
{%- endif -%}

{%- assign override_forms = include.forms | default: section.data.forms -%}

{%- assign sort_key_field = section.data.sort_by | default:"date" -%}
{%- assign reverse_flag = section.data.reverse == true -%}

{%- assign filtered_posts = "" | split:"|" -%}
{%- for p in posts -%}
  {%- assign keep = true -%}

  {%- comment -%} Author filtering {%- endcomment -%}
  {%- if override_authors -%}
    {%- assign author_match = false -%}
    {%- if p.authors -%}
      {%- for a in p.authors -%}
        {%- if override_authors contains a -%}
          {%- assign author_match = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
    {%- if author_match == false -%}
      {%- assign keep = false -%}
    {%- endif -%}
  {%- endif -%}

  {%- comment -%} Forms filtering {%- endcomment -%}
  {%- if keep and override_forms -%}
    {%- assign form_match = false -%}
    {%- if p.forms -%}
      {%- for f in p.forms -%}
        {%- if override_forms contains f -%}
          {%- assign form_match = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      {%- comment -%} derive slug from filename (slug.md) {%- endcomment -%}
      {%- assign filename = p.path | split:"/" | last -%}
      {%- assign slug = filename | split:"." | first -%} 
      {%- if override_forms contains slug -%}
        {%- assign form_match = true -%}
      {%- endif -%}
    {%- endif -%}
    {%- if form_match == false -%}
      {%- assign keep = false -%}
    {%- endif -%}
  {%- endif -%}

  {%- if keep -%}
    {%- assign filtered_posts = filtered_posts | push: p -%}
  {%- endif -%}
{%- endfor -%}

{%- assign filtered_posts = filtered_posts | sort: sort_key_field -%}
{%- if reverse_flag -%}{%- assign filtered_posts = filtered_posts | reverse -%}{%- endif -%}
{%- if section.data.post_display_limit -%}
  {%- assign filtered_posts = filtered_posts | slice: 0, section.data.post_display_limit -%}
{%- endif -%}

<section id="collection-stream" class="md-flow">
  {%- for post in filtered_posts -%}
    {% include sections/collection-item.html post=post excerpt_length=section.data.excerpt_length %}
  {%- endfor -%}
</section>
