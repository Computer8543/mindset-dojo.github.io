{%- comment -%}
Compact grouped-principles renderer
Expect data_source.principles to be a map:
  principles:
    program: [...]
    project: [...]
    mission: [...]
Inputs:
- section.data.principles_title
- section.data.principles  (array of ids, optional)
- section.data.principle_type (string, optional)
- page.principles (fallback)
{%- endcomment -%}

{%- assign title = include.principles_title | default: section.data.principles_title | default: "Principles" -%}
{%- assign data_source = include.page_data | default: site.data.sections.principles -%}
{%- assign grouped = data_source.principles -%}
{%- assign src = include.principles | default: section.data.principles -%}
{%- assign sel_type = section.data.principle_type -%}

{%- assign final_items = "" | split: "|" -%}

<p class="debug">src = {{ src | join: " | " }}</p>

<p class="debug">group keys:
  {%- for k in grouped -%}
    {{ k }}{% if forloop.last == false %}, {% endif %}
  {%- endfor -%}
</p>

{%- if src -%}
  {%- assign principle_group = "" | split "|" -%}
  {%- assign principle_group = principle_group | push: "program" | push: "project" | push: "mission" -%}
  {%- for want_id in src -%}
    {%- assign found = nil -%}
    {%- for key in principle_group -%}
      {%- for group_list in grouped[key] -%}
        {%- for candidate in group_list -%}
          {%- if candidate.id == want_id -%}
            {%- assign found = candidate -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if found -%}{%- break -%}{%- endif -%}
      {%- endfor -%}
      {%- if found -%}{%- break -%}{%- endif -%}
    {%- endfor -%}
    {%- if found -%}{%- assign final_items = final_items | push: found -%}{%- endif -%}
  {%- endfor -%}
{%- else -%}
  {%- if sel_type and grouped[sel_type] -%}
    {%- for item in grouped[sel_type] -%}
      {%- assign final_items = final_items | push: item -%}
    {%- endfor -%}
  {%- else -%}
    {%- for group_key in grouped -%}
      {%- for item in grouped[group_key] -%}
        {%- assign final_items = final_items | push: item -%}
      {%- endfor -%}
    {%- endfor -%}
  {%- endif -%}
{%- endif -%}

<section class="md-flow">
  <h2>{{ title }}</h2>
  <dl>
    {%- for item in final_items -%}
      {%- assign _id = "principle-" | append: item.id | slugify -%}
      <dt id="{{ _id }}">{{ item.label }}</dt>
      <dd aria-labelledby="{{ _id }}">{{ item.description | markdownify }}</dd>
    {%- endfor -%}
  </dl>
</section>
