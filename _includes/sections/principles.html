{%- comment -%}
Principles include — strict inputs and sequential filtering.

Behavior:
- site.data.sections.principles.items expected (each item: id, type, ...)
- src MUST be an ARRAY of ids if provided
- sel_type SHOULD be a SINGLE string; if an array is passed accidentally we use its first element
- Sequential pipeline: start with all items -> filter by type (if valid) -> filter by src (if provided)
{%- endcomment -%}

{%- assign data = site.data.sections.principles -%}

{%- if data == nil or data.items == nil -%}
  {%- assign data_items = "" | split: "|" -%}
{%- else -%}
  {%- assign data_items = data.items -%}
{%- endif -%}

{%- assign src = include.principles | default: section.data.principles | default: page.principles -%}
{%- assign sel_type = include.principle_type | default: section.data.principle_type | default: page.principle_type -%}

{%- comment -%}
Normalize sel_type to a string if an array was accidentally passed.
This prevents slugify/from-gsub errors when templates pass an array by mistake.
{%- endcomment -%}
{%- if sel_type and sel_type[0] != nil -%}
  {%- assign sel_type = sel_type[0] -%}
{%- endif -%}

{%- comment -%} Build allowed types from the dataset (slugified) {%- endcomment -%}
{%- assign allowed = "" | split: "|" -%}
{%- for it in data_items -%}
  {%- if it.type -%}
    {%- assign allowed = allowed | push: (it.type | to_s | slugify) -%}
  {%- endif -%}
{%- endfor -%}
{%- assign allowed = allowed | uniq -%}

{%- comment -%}
Sequential filtering:
1) start with all items
2) if sel_type is present and valid → filter by item.type
3) if src is an array → filter by id according to src order
{%- endcomment -%}

{%- assign filtered = "" | split: "|" -%}
{%- for it in data_items -%}
  {%- assign filtered = filtered | push: it -%}
{%- endfor -%}

{%- if sel_type and sel_type != "" -%}
  {%- assign sel_norm = sel_type | to_s | slugify -%}
  {%- if allowed contains sel_norm -%}
    {%- assign after_type = "" | split: "|" -%}
    {%- for it in filtered -%}
      {%- if it.type | to_s | slugify == sel_norm -%}
        {%- assign after_type = after_type | push: it -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign filtered = after_type -%}
  {%- else -%}
    {%- comment -%} sel_type provided but not in allowed list → produce empty list {%- endcomment -%}
    {%- assign filtered = "" | split: "|" -%}
  {%- endif -%}
{%- endif -%}

{%- if src and src[0] != nil -%}
  {%- assign wants = src -%}
  {%- assign by_id = "" | split: "|" -%}
  {%- for want in wants -%}
    {%- assign want_norm = want | to_s | slugify -%}
    {%- for it in filtered -%}
      {%- if it.id == want or it.id == want_norm -%}
        {%- assign by_id = by_id | push: it -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endfor -%}
  {%- assign filtered = by_id -%}
{%- endif -%}

{%- assign list_section = { "label": "Principles", "items": filtered } -%}

{% include sections/list.html section=list_section %}
