{%- comment -%}
Render principles referenced by a page or section.

Inputs accepted:
- include.principles (array or CSV/JSON-like string)
- section.data.principles
- page.principles

Also supports selecting a full type via:
- include.principle_type or section.data.principle_type (maps into principle_type)

Outputs:
- Calls sections/list.html with section object: { label, items }
{%- endcomment -%}

{%- assign D = section.data -%}
{%- comment -%} normalize source of requested principle ids {%- endcomment -%}
{%- assign src = section.data.principles -%}
{%- assign sel_types = section.data.principle_type -%}
{%- assign principles_data = site.data.principles -%}
{%- assign matched = "" | split: "|" -%}


{%- comment -%} ensure section_types is iterable (normalize single string) {%- endcomment -%}
{%- if sel_types and sel_types[0] == nil -%}
  {%- assign sel_types = sel_types | split: ',' | map: 'strip' -%}
{%- endif -%}

{%- comment -%} collect items matching the requested types {%- endcomment -%}
{%- assign matched = "" | split: "|" -%}
{%- for item in principles_data.items -%}
  {%- for want_type in sel_types -%}
    {%- if item.type == want_type -%}
      {%- assign matched = matched | push: item -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
{%- endfor -%}

{%- comment -%} normalize src into `wants` array if needed {%- endcomment -%}
{%- if src and src[0] == nil -%}
  {%- assign s = src | to_s | strip -%}
  {%- if s contains '[' and s contains ']' -%}
    {%- assign s = s | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
  {%- endif -%}
  {%- if s contains ',' -%}
    {%- assign wants = s | split:',' | map:'strip' -%}
  {%- else -%}
    {%- assign wants = s | split:'\n' | map:'strip' -%}
  {%- endif -%}
{%- else -%}
  {%- assign wants = src -%}
{%- endif -%}

{%- if wants and wants.size > 0 -%}
    {%- comment -%} filter matched items to only those requested {%- endcomment -%}
    {%- assign final_items = "" | split: "|" -%}
    {%- for want_id in wants -%}
    {%- for item in matched -%}
        {%- if item.id == want_id -%}
        {%- assign final_items = final_items | push: item -%}
        {%- break -%}
        {%- endif -%}
    {%- endfor -%}
    {%- endfor -%}
{%- else -%}
        {%- assign final_items = matched -%}
{%- endif -%}


{%- comment -%} render the list of principles {%- endcomment -%}
{%- assign section = 
    {
    "label": "Related Principles",
    "items": final_items
    } 
-%}
{%- include sections/list.html section=section -%}
