{%- comment -%}
Static dispatcher for section includes (broad Jekyll compatibility).
Each case delegates to a small, focused template for that section type.
{%- endcomment -%}

{%- case section.type -%}

  {%- when 'author' -%}
    {%- assign slug = page.slug | downcase -%}
    {%- assign one_author = "" | split:"|" -%}
    {%- assign one_author = one_author | push: slug -%}
    {% include sections/authors.html section=section authors=one_author %}

  {%- when 'authors' -%}
    {% include sections/authors.html section=section %}

  {%- when 'collection-item' -%}
    {% include sections/collection-item.html section=section data=data %}

  {%- when 'collection-stream' -%}
    {%- comment -%}
      Simplified, readable collection-stream dispatcher:
      - Use include.filters (if string, parse it)
      - Otherwise build single-key filter from filter_key + filter_values
      - Auto-add authors filter for author pages (only when none provided)
      - Merge any keys in section.data.filters
      - Always output a native hash
    {%- endcomment -%}

    {%- assign filters = nil -%}

    {%- comment -%} 1) include.filters (use-as-is if hash; parse if string) {%- endcomment -%}
    {%- if include.filters -%}
      {%- assign raw_filters = include.filters -%}
      {%- if raw_filters == raw_filters | append: '' -%} {# raw is a string -> parse #}
        {%- assign first_char = raw_filters | slice: 0, 1 -%}
        {%- if first_char == '"' -%}
          {%- assign inner = raw_filters | slice: 1, raw_filters | size | minus: 2 -%}
          {%- assign filters = inner | parse_json -%}
        {%- else -%}
          {%- assign filters = raw_filters | parse_json -%}
        {%- endif -%}
      {%- else -%}
        {%- assign filters = raw_filters -%}
      {%- endif -%}
    {%- endif -%}

    {%- comment -%} 2) build from filter_key + filter_values if still nil {%- endcomment -%}
    {%- if filters == nil and include.filter_key and include.filter_values -%}
      {%- assign fv = include.filter_values | array -%}
      {%- assign keyname = include.filter_key | strip -%}
      {%- assign filters = '{"' | append: keyname | append: '":' | append: (fv | jsonify) | append: '}' | parse_json -%}
    {%- endif -%}

    {%- comment -%}
      3) Auto-add authors filter ONLY when we still have no authors filter and we are
      rendering an author page. Use direct slug insertion to avoid double-quoting.
    {%- endcomment -%}
    {%- if page.sections_key == "author" and (filters == nil or filters.authors == nil) -%}
      {%- if filters == nil -%}
        {%- assign filters = '{"authors":["' | append: page.slug | append: '"]}' | parse_json -%}
      {%- else -%}
        {%- assign filters = filters | merge: ( '{"authors":["' | append: page.slug | append: '"]}' | parse_json ) -%}
      {%- endif -%}
    {%- endif -%}

    {%- comment -%} 4) Merge any explicit section.data.filters (preserve types) {%- endcomment -%}
    {%- if section.data.filters -%}
      {%- assign merged = filters | default: '{}' | parse_json -%}
      {%- for key in section.data.filters -%}
        {%- assign val = section.data.filters[key] -%}
        {%- assign fragment = '{"' | append: key | append: '":' | append: (val | jsonify) | append: '}' -%}
        {%- assign merged = merged | merge: (fragment | parse_json) -%}
      {%- endfor -%}
      {%- assign filters = merged -%}
    {%- endif -%}

    {%- comment -%} 5) Ensure filters is a hash (safe fallback) {%- endcomment -%}
    {%- if filters == nil -%}
      {%- assign filters = '{}' | parse_json -%}
    {%- endif -%}

    {%- comment -%} DEBUG: remove this line after verifying output in page HTML source {%- endcomment -%}
    <!-- debug: collection-stream filters = {{ filters | jsonify }} -->

    {%- assign coll = include.collection | default: section.data.collection -%}
    {%- assign excerpt_length = include.excerpt_length | default: section.data.excerpt_length -%}
    {%- assign post_display_limit = include.post_display_limit | default: section.data.post_display_limit -%}

    {% include sections/collection-stream.html
      section=section
      collection=coll
      filters=filters
      excerpt_length=excerpt_length
      post_display_limit=post_display_limit
    %}

  {%- when 'ctas' -%}
    {% include sections/ctas.html section=section %}

  {%- when 'designations' -%}
    {% include sections/designations.html section=section data=data %}
  
  {%- when 'levels' -%}
    {% include sections/levels.html section=section %}

  {%- when 'list' -%}
    {% include sections/list.html section=section %}

  {%- when 'markdown' -%}
    {% include sections/markdown.html section=section %}

  {%- when 'principles' -%}
    {% include sections/principles.html section=section page_data=site.data.sections.principles %}

  {%- when 'quote' -%}
    {% include sections/quote.html section=section %}

  {%- when 'text' -%}
    {% include sections/text.html section=section %}

{%- endcase -%}
