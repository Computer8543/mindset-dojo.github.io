{%- comment -%}
Static dispatcher for section includes (broad Jekyll compatibility).
Each case delegates to a small, focused template for that section type.
{%- endcomment -%}

{%- case section.type -%}

  {%- when 'author' -%}
    {%- assign slug = page.slug | downcase -%}
    {%- assign one_author = "" | split:"|" -%}
    {%- assign one_author = one_author | push: slug -%}
    {% include sections/authors.html section=section authors=one_author %}

  {%- when 'authors' -%}
    {% include sections/authors.html section=section %}

  {%- when 'collection-item' -%}
    {% include sections/collection-item.html section=section data=data %}

  {%- when 'collection-stream' -%}
    {%- comment -%}
      Robust dispatcher for collection-stream that avoids literal "left bracket symbol" in conditions.
      Accepts include.filters (map or JSON/string), include.filter_key+filter_values shorthand,
      or section.data.filters. Normalizes into `filters` (nil or a real hash), and
      replaces placeholder "__PAGE_SLUG__" with page.slug while preserving other keys.
    {%- endcomment -%}

    {%- assign raw = nil -%}

    {%- if include.filters -%}
      {%- assign raw = include.filters -%}
    {%- elsif include.filter_key and include.filter_values -%}
      {%- assign fv = include.filter_values | array -%}
      {%- assign keyname = include.filter_key | strip -%}
      {%- assign filters_json = '{"' | append: keyname | append: '":' | append: (fv | jsonify) | append: '}' -%}
      {%- assign raw = filters_json -%}
    {%- else -%}
      {%- assign raw = section.data.filters | default: nil -%}
    {%- endif -%}

    {%- if raw == blank -%}
      {%- assign filters = nil -%}
    {%- elsif raw == raw | append: '' -%}
      {%- comment -%} raw is a string (JSON or quoted JSON) â€” determine which {%- endcomment -%}
      {%- assign first_char = raw | slice: 0, 1 -%}
      {%- if first_char == '"' -%}
        {%- assign raw_len = raw | size -%}
        {%- assign inner_len = raw_len | minus: 2 -%}
        {%- assign inner = raw | slice: 1, inner_len -%}
        {%- assign filters = inner | parse_json -%}
      {%- else -%}
        {%- assign filters = raw | parse_json -%}
      {%- endif -%}
    {%- else -%}
      {%- assign filters_json = raw | jsonify -%}
      {%- assign filters = filters_json | parse_json -%}
    {%- endif -%}

    {%- comment -%} 
      Preserve other keys and replace placeholder "__PAGE_SLUG__" in any array values.
    {%- endcomment -%}
    {%- if filters -%}
      {%- assign merged_filters = {} -%}
      {%- for key in filters -%}
        {%- assign val = filters[key] -%}
        {%- if val == val | append: '' and val contains "__PAGE_SLUG__" -%}
          {%- assign val_array = val | split: ',' -%} {# split single string in case comma-delimited #}
          {%- assign new_val_array = '' -%}
          {%- for item in val_array -%}
            {%- assign item_trim = item | strip -%}
            {%- if item_trim == "__PAGE_SLUG__" -%}
              {%- assign item_trim = page.slug | default: "" -%}
            {%- endif -%}
            {%- if forloop.first -%}
              {%- assign new_val_array = item_trim -%}
            {%- else -%}
              {%- assign new_val_array = new_val_array | append: ',' | append: item_trim -%}
            {%- endif -%}
          {%- endfor -%}
          {%- assign merged_filters = merged_filters | merge: key | parse_json: '{"' | append: key | append '":[' | append: new_val_array | append: ']}' -%}
        {%- else -%}
          {%- assign merged_filters = merged_filters | merge: key | parse_json: '{"' | append: key | append '":' | append: val | append: '}' -%}
        {%- endif -%}
      {%- endfor -%}
      {%- assign filters = merged_filters -%}
    {%- endif -%}

    {%- assign coll = include.collection | default: section.data.collection -%}
    {%- assign excerpt_length = include.excerpt_length | default: section.data.excerpt_length -%}
    {%- assign post_display_limit = include.post_display_limit | default: section.data.post_display_limit -%}

    {% include sections/collection-stream.html
      section=section
      collection=coll
      filters=filters
      excerpt_length=excerpt_length
      post_display_limit=post_display_limit
    %}

  {%- when 'ctas' -%}
    {% include sections/ctas.html section=section %}

  {%- when 'designations' -%}
    {% include sections/designations.html section=section data=data %}
  
  {%- when 'levels' -%}
    {% include sections/levels.html section=section %}

  {%- when 'list' -%}
    {% include sections/list.html section=section %}

  {%- when 'markdown' -%}
    {% include sections/markdown.html section=section %}

  {%- when 'principles' -%}
    {% include sections/principles.html section=section page_data=site.data.sections.principles %}

  {%- when 'quote' -%}
    {% include sections/quote.html section=section %}

  {%- when 'text' -%}
    {% include sections/text.html section=section %}

{%- endcase -%}
