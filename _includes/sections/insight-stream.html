{%- comment -%}
Renders a stream of posts from a collection.
section.data.collection -> collection name (default: "insight")
section.data.sort_by -> field to sort by (default: "date")
section.data.reverse -> boolean to reverse sort (default: true)
section.data.excerpt_length -> integer for excerpt length (default: 220)
section.data.authors -> optional list of author slugs to filter by (same formats as authors
New features:
- Accepts section.data.authors or include.authors to restrict to a set of author slugs
  (same input formats as authors.html: array, JSON-ish string, comma-separated, single slug).
- Supports grouping by author when section.data.group_by == "author" (or include.group_by).
  In group mode each author gets a header (uses sections/author.html) and their posts.
- Preserves existing sorting via section.data.sort_by and section.data.reverse.
- When grouping we call insight-item.html with hide_author=true to avoid repeating the author card.
{%- endcomment -%}

{%- assign coll_name = section.data.collection | default: "insight" -%}
{%- assign posts = site[coll_name] -%}
{%- if posts == nil -%}
  <section class="md-flow">
    <p><em>No collection named <code>{{ coll_name }}</code> found.</em></p>
  </section>
{%- else -%}
  {%- comment -%} normalize override authors (from include or section.data) {%- endcomment -%}
  {%- assign raw_override = include.authors | default: section.data.authors | default: "" -%}
  {%- assign use_override = raw_override != "" -%}
  {%- if use_override -%}
    {%- if raw_override[0] != nil -%}
      {%- assign override_slugs = raw_override -%}
    {%- elsif raw_override contains '[' and raw_override contains ']' -%}
      {%- assign tmp = raw_override | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
      {%- assign override_slugs = tmp | split:',' | map:'strip' -%}
    {%- elsif raw_override contains ',' -%}
      {%- assign override_slugs = raw_override | split:',' | map:'strip' -%}
    {%- else -%}
      {%- assign override_slugs = raw_override | split:'\n' | map:'strip' -%}
    {%- endif -%}
    {%- comment -%} normalize each slug (take before '.' and slugify) {%- endcomment -%}
    {%- assign override_slugs_norm = "" | split: "|" -%}
    {%- for s in override_slugs -%}
      {%- assign s_norm = s | split:'.' | first | slugify -%}
      {%- assign override_slugs_norm = override_slugs_norm | push: s_norm -%}
    {%- endfor -%}
  {%- endif -%}

  {%- assign sort_key = section.data.sort_by | default: "date" -%}
  {%- assign reverse_flag = section.data.reverse | default: true -%}

  {%- comment -%}
  Helpers: function-like blocks to extract normalized author slugs from a post.
  (Liquid lacks real functions; we inline the logic where needed.)
  {%- endcomment -%}

  {%- if section.data.group_by == "author" or include.group_by == "author" -%}
    {%- comment -%} Build list of author docs to iterate (override -> strict selection) {%- endcomment -%}
    {%- if use_override -%}
      {%- assign author_docs = "" | split: "|" -%}
      {%- for s in override_slugs_norm -%}
        {%- assign doc = site.authors | where: "slug", s | first -%}
        {%- if doc -%}
          {%- assign author_docs = author_docs | push: doc -%}
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      {%- assign author_docs = site.authors -%}
    {%- endif -%}

    <section id="insights-by-author">
      {%- for author in author_docs -%}
        {%- comment -%} collect posts for this author {%- endcomment -%}
        {%- assign matched = "" | split: "|" -%}
        {%- for p in posts -%}
          {%- assign p_auth = p.authors -%}
          {%- assign p_slugs = "" | split: "|" -%}

          {%- if p_auth -%}
            {%- if p_auth[0] != nil -%}
              {%- assign p_slugs = p_auth -%}
            {%- else -%}
              {%- assign s = p_auth | to_s | strip -%}
              {%- if s contains '[' and s contains ']' -%}
                {%- assign s = s | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
                {%- assign p_slugs = s | split:',' | map:'strip' -%}
              {%- elsif s contains ',' -%}
                {%- assign p_slugs = s | split:',' | map:'strip' -%}
              {%- else -%}
                {%- assign p_slugs = s | split:'\n' | map:'strip' -%}
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}

          {%- comment -%} normalize and compare any slug in p_slugs against author.slug {%- endcomment -%}
          {%- assign matched_flag = false -%}
          {%- for ps in p_slugs -%}
            {%- assign ps_norm = ps | split:'.' | first | slugify -%}
            {%- if ps_norm == author.slug -%}{%- assign matched_flag = true -%}{%- endif -%}
          {%- endfor -%}

          {%- if matched_flag -%}
            {%- assign matched = matched | push: p -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if matched.size > 0 -%}
          {%- comment -%} sort matched posts {%- endcomment -%}
          {%- assign matched = matched | sort: sort_key -%}
          {%- if reverse_flag -%}{%- assign matched = matched | reverse -%}{%- endif -%}

          <section class="md-flow md-author-section">
            {% include sections/author.html author=author %}
            <div class="md-insight-list">
              {%- for post in matched -%}
                {% include sections/insight-item.html post=post excerpt_length=section.data.excerpt_length hide_author=true %}
              {%- endfor -%}
            </div>
          </section>
        {%- endif -%}
      {%- endfor -%}
    </section>

  {%- else -%}
    {%- comment -%} Non-grouped mode: optionally filter posts to the override slugs, else show all posts {%- endcomment -%}
    {%- assign filtered = "" | split: "|" -%}
    {%- for p in posts -%}
      {%- if use_override -%}
        {%- assign p_auth = p.authors -%}
        {%- assign p_slugs = "" | split: "|" -%}

        {%- if p_auth -%}
          {%- if p_auth[0] != nil -%}
            {%- assign p_slugs = p_auth -%}
          {%- else -%}
            {%- assign s = p_auth | to_s | strip -%}
            {%- if s contains '[' and s contains ']' -%}
              {%- assign s = s | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
              {%- assign p_slugs = s | split:',' | map:'strip' -%}
            {%- elsif s contains ',' -%}
              {%- assign p_slugs = s | split:',' | map:'strip' -%}
            {%- else -%}
              {%- assign p_slugs = s | split:'\n' | map:'strip' -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}

        {%- assign keep = false -%}
        {%- for ps in p_slugs -%}
          {%- assign ps_norm = ps | split:'.' | first | slugify -%}
          {%- if override_slugs_norm contains ps_norm -%}
            {%- assign keep = true -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if keep -%}{%- assign filtered = filtered | push: p -%}{%- endif -%}
      {%- else -%}
        {%- assign filtered = filtered | push: p -%}
      {%- endif -%}
    {%- endfor -%}

    {%- assign filtered = filtered | sort: sort_key -%}
    {%- if reverse_flag -%}{%- assign filtered = filtered | reverse -%}{%- endif -%}

    <section id="insights-stream">
      {%- for post in filtered -%}
        {% include sections/insight-item.html post=post excerpt_length=section.data.excerpt_length %}
      {%- endfor -%}
    </section>
  {%- endif -%}
{%- endif -%}