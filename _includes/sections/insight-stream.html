{%- comment -%}
Renders a stream of posts from a collection.
section.data.collection -> collection name (default: "insight")
section.data.sort_by -> field to sort by (default: "date")
section.data.reverse -> boolean to reverse sort (only if explicitly true)
section.data.excerpt_length -> integer for excerpt length (default: 220)
section.data.authors -> optional list of author slugs to filter by (same formats as authors)
New behavior:
- Accepts section.data.authors or include.authors to restrict to a set of author slugs
  (input formats: array, JSON-ish string, comma-separated, single slug).
- If no author override is provided and `page.slug` exists, use `page.slug` as the author filter.
- Supports grouping by author when section.data.group_by == "author" (or include.group_by).
- Preserves existing sorting via section.data.sort_by and section.data.reverse.
- When grouping we call insight-item.html with hide_author=true to avoid repeating the author card.
{%- endcomment -%}

{%- assign coll_name = section.data.collection | default: "insight" -%}
{%- assign posts = site[coll_name] -%}
{%- comment -%} DEBUG: show runtime state (remove when finished) {%- endcomment -%}
{%- if posts == nil -%}
  <section class="md-flow">
    <p><em>No collection named <code>{{ coll_name }}</code> found.</em></p>
  </section>
{%- else -%}
  {%- for p in posts limit:1 -%}
    {%- capture p_slugs_csv -%}{% include sections/parse-post-authors.html p_auth=p.authors %}{%- endcapture -%}
    <p class="debug">POST DEBUG: {{ p.title }} → raw authors: {{ p.authors | inspect }} → parsed CSV: {{ p_slugs_csv }}</p>
  {%- endfor -%}

  {%- comment -%} normalize override authors (from include or section.data) {%- endcomment -%}
  {%- assign raw_override = include.authors | default: section.data.authors | default: "" -%}
  {%- assign override_slugs = "" | split: "|" -%}
  {%- assign override_slugs_norm = "" | split: "|" -%}

  {%- if raw_override != "" -%}
    {%- assign raw_json = raw_override | jsonify -%}

    {%- if raw_json contains '[' and raw_json contains ']' -%}
      {%- assign tmp = raw_json | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
      {%- assign override_slugs = tmp | split:',' | map:'strip' -%}

    {%- elsif raw_json contains ',' -%}
      {%- assign tmp = raw_json | remove:'"' | remove:"'" | strip -%}
      {%- assign override_slugs = tmp | split:',' | map:'strip' -%}

    {%- else -%}
      {%- assign tmp = raw_json | remove:'"' | remove:"'" | strip -%}
      {%- if tmp == "" -%}
        {%- assign override_slugs = "" | split: "|" -%}
      {%- else -%}
        {%- assign override_slugs = tmp | split:'\n' | map:'strip' -%}
      {%- endif -%}
    {%- endif -%}

    {%- for s in override_slugs -%}
      {%- assign s_norm = s | split:'.' | first | slugify -%}
      {%- assign override_slugs_norm = override_slugs_norm | push: s_norm -%}
    {%- endfor -%}
  {%- endif -%}

  {%- comment -%}
  If no explicit override was provided, fall back to page.slug (common pattern: author/insight pages)
  {%- endcomment -%}
  {%- if override_slugs_norm.size == 0 and page and page.slug -%}
    {%- assign pg_slug_norm = page.slug | slugify -%}
    {%- assign override_slugs_norm = override_slugs_norm | push: pg_slug_norm -%}
  {%- endif -%}

  {%- assign sort_key = section.data.sort_by | default: "date" -%}

  {%- comment -%}
  Make reverse explicit: only reverse if section.data.reverse is explicitly true.
  {%- endcomment -%}
  {%- assign reverse_flag = false -%}
  {%- if section.data.reverse != nil and section.data.reverse == true -%}
    {%- assign reverse_flag = true -%}
  {%- endif -%}

  {%- if section.data.group_by == "author" or include.group_by == "author" -%}
    {%- comment -%} Build list of author docs to iterate (override -> strict selection) {%- endcomment -%}
    {%- comment -%}
    Defensive author_docs build:
    - Iterates site.authors and selects any author whose slug matches (or is contained in)
      any normalized override token. This avoids strict where: lookups that miss due to
    whitespace, hidden chars, or slight formatting differences.
    {%- endcomment -%}

    {%- assign author_docs = "" | split: "|" -%}

    {%- if override_slugs_norm.size > 0 -%}
      {%- comment -%} Normalize override values once for robust comparisons {%- endcomment -%}
      {%- assign norm_overrides = "" | split: "|" -%}
      {%- for s in override_slugs_norm -%}
        {%- assign s_norm = s | slugify | strip -%}
        {%- if s_norm != "" -%}{%- assign norm_overrides = norm_overrides | push: s_norm -%}{%- endif -%}
      {%- endfor -%}

      {%- for a in site.authors -%}
        {%- assign a_slug = a.slug | slugify | strip -%}
        {%- if a_slug == "" -%}
          {%- continue -%}
        {%- endif -%}

        {%- assign matched = false -%}
        {%- for s in norm_overrides -%}
          {%- if s == a_slug or s contains a_slug or a_slug contains s -%}
            {%- assign matched = true -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if matched -%}
          {%- assign author_docs = author_docs | push: a -%}
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      {%- assign author_docs = site.authors -%}
    {%- endif -%}


    <section id="insights-by-author">
      {%- for author in author_docs -%}
        {%- comment -%} collect posts for this author {%- endcomment -%}
        {%- assign matched = "" | split: "|" -%}
        {%- for p in posts -%}
          {%- comment -%} parse p.authors into a normalized slug list via include {%- endcomment -%}
          {%- capture p_slugs_csv -%}{% include sections/parse-post-authors.html p_auth=p.authors %}{%- endcapture -%}
          
          {%- if p_slugs_csv != "" -%}
            {%- assign p_slugs = p_slugs_csv | split:',' | map:'strip' -%}
          {%- else -%}
            {%- assign p_slugs = "" | split: "|" -%}
          {%- endif -%}

          {%- assign matched_flag = false -%}
          {%- for ps in p_slugs -%}
            {%- if ps | split:'.' | first | slugify | strip == author.slug -%}
              {%- assign matched_flag = true -%}
            {%- endif -%}
          {%- endfor -%}

          {%- if matched_flag -%}
            {%- assign matched = matched | push: p -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if matched.size > 0 -%}
          {%- comment -%} sort matched posts {%- endcomment -%}
          {%- assign matched = matched | sort: sort_key -%}
          {%- if reverse_flag -%}{%- assign matched = matched | reverse -%}{%- endif -%}

          <section class="md-author-flow">
            {% include sections/author.html author=author %}
            <div class="md-insight-list">
              {%- for post in matched -%}
                <!-- DEBUG: show posts before invoking insight-item -->
                <p class="debug">DEBUG MATCHED POST: {{ post.title | default: post.path }} — raw authors: {{ post.authors | inspect }}</p>
                {%- comment -%} temporarily comment out the insight-item include to test {%- endcomment -%}
                {# {% include sections/insight-item.html post=post excerpt_length=section.data.excerpt_length hide_author=true %} #}
              {%- endfor -%}
            </div>
          </section>
        {%- endif -%}
      {%- endfor -%}
    </section>

  {%- else -%}
    {%- comment -%} Non-grouped mode: optionally filter posts to the override slugs, else show all posts {%- endcomment -%}
    {%- assign filtered = "" | split: "|" -%}
    {%- for p in posts -%}
      {%- if override_slugs_norm.size > 0 -%}
        {%- comment -%} parse p.authors into normalized slug list via include {%- endcomment -%}
        {%- capture p_slugs_csv -%}{% include sections/parse-post-authors.html p_auth=p.authors %}{%- endcapture -%}
        {%- if p_slugs_csv != "" -%}
          {%- assign p_slugs = p_slugs_csv | split:',' | map:'strip' -%}
        {%- else -%}
          {%- assign p_slugs = "" | split: "|" -%}
        {%- endif -%}

        {%- assign keep = false -%}
        {%- for ps in p_slugs -%}
          {%- if override_slugs_norm contains ps -%}
            {%- assign keep = true -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if keep -%}{%- assign filtered = filtered | push: p -%}{%- endif -%}
      {%- else -%}
        {%- assign filtered = filtered | push: p -%}
      {%- endif -%}
    {%- endfor -%}

    {%- assign filtered = filtered | sort: sort_key -%}
    {%- if reverse_flag -%}{%- assign filtered = filtered | reverse -%}{%- endif -%}

    <section id="insights-stream">
      {%- for post in filtered -%}
        {% include sections/insight-item.html post=post excerpt_length=section.data.excerpt_length %}
      {%- endfor -%}
    </section>
  {%- endif -%}
{%- endif -%}
