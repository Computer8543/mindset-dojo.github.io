{%- comment -%}
Renders a stream of posts from a collection.
section.data.collection -> collection name (default: "insight")
section.data.sort_by -> field to sort by (default: "date")
section.data.reverse -> boolean to reverse sort (only if explicitly true)
section.data.excerpt_length -> integer for excerpt length (default: 220)
section.data.authors -> optional list of author slugs to filter by (same formats as authors)
New behavior:
- Accepts section.data.authors or include.authors to restrict to a set of author slugs
  (input formats: array, JSON-ish string, comma-separated, single slug).
- If no author override is provided and `page.slug` exists, use `page.slug` as the author filter.
- Supports grouping by author when section.data.group_by == "author" (or include.group_by).
- Preserves existing sorting via section.data.sort_by and section.data.reverse.
- When grouping we call insight-item.html with hide_author=true to avoid repeating the author card.
{%- endcomment -%}

{%- assign coll_name = include.collection | default: 'insight' -%}
{%- assign coll = site[coll_name] -%}

{%- assign raw_override = include.override_slugs | default: "" -%}
{%- assign override_slugs = raw_override | split: ',' | map: 'strip' -%}
{%- assign override_slugs_norm = "" | split: "," -%}

{%- for slug in override_slugs -%}
  {%- assign slug_norm = slug | downcase | strip -%}
  {%- assign override_slugs_norm = override_slugs_norm | push: slug_norm -%}
{%- endfor -%}

{%- assign page_slug_norm = page.slug | downcase | strip -%}
{%- assign use_override = override_slugs_norm | size | gt: 0 -%}

{%- assign filtered = "" | split: "|" -%}
{%- assign grouped = site.data.insight_groups | default: nil -%}

{%- for p in coll -%}
  {%- assign p_auth = p.authors -%}
  {%- assign p_slugs = "" | split: "|" -%}

  {%- if p_auth -%}
    {%- if p_auth[0] != nil -%}
      {%- assign p_slugs = p_auth -%}
    {%- else -%}
      {%- assign p_json = p_auth | jsonify -%}

      {%- if p_json contains '[' and p_json contains ']' -%}
        {%- assign tmp = p_json | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
        {%- assign p_slugs = tmp | split:',' | map:'strip' -%}

      {%- elsif p_json contains ',' -%}
        {%- assign tmp = p_json | remove:'"' | remove:"'" | strip -%}
        {%- assign p_slugs = tmp | split:',' | map:'strip' -%}

      {%- else -%}
        {%- assign tmp = p_json | remove:'"' | remove:"'" | strip -%}
        {%- assign p_slugs = tmp | split:'\n' | map:'strip' -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}

  {%- assign p_slugs_norm = "" | split: "," -%}
  {%- for s in p_slugs -%}
    {%- assign s_norm = s | downcase | strip -%}
    {%- assign p_slugs_norm = p_slugs_norm | push: s_norm -%}
  {%- endfor -%}

  {%- assign match = false -%}
  {%- if use_override -%}
    {%- for slug in override_slugs_norm -%}
      {%- if p_slugs_norm contains slug -%}
        {%- assign match = true -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- else -%}
    {%- if p_slugs_norm contains page_slug_norm -%}
      {%- assign match = true -%}
    {%- endif -%}
  {%- endif -%}

  {%- if match -%}
    {%- assign filtered = filtered | push: p -%}
  {%- endif -%}
{%- endfor -%}

{%- if include.debug or page.debug -%}
<!-- INSIGHT-STREAM DEBUG START
      coll_name: {{ coll_name }}
      posts_count: {{ coll | size }}
      raw_override: "{{ raw_override }}"
      override_slugs (raw): {{ override_slugs | inspect }}
      override_slugs_norm: {{ override_slugs_norm | inspect }}
      page.slug: {{ page.slug }}
      page.slug (norm): {{ page_slug_norm }}

      Filtered count: {{ filtered | size }}

      First 20 posts (title | url | p.authors | parsed p_slugs_norm):
-->
  {%- assign counter = 0 -%}
  {%- for p in coll -%}
    {%- assign counter = counter | plus: 1 -%}
    {%- if counter > 20 -%}{%- break -%}{%- endif -%}
    {%- assign p_auth = p.authors -%}
    {%- assign p_slugs = "" | split: "|" -%}

    {%- if p_auth -%}
      {%- if p_auth[0] != nil -%}
        {%- assign p_slugs = p_auth -%}
      {%- else -%}
        {%- assign p_json = p_auth | jsonify -%}

        {%- if p_json contains '[' and p_json contains ']' -%}
          {%- assign tmp = p_json | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
          {%- assign p_slugs = tmp | split:',' | map:'strip' -%}

        {%- elsif p_json contains ',' -%}
          {%- assign tmp = p_json | remove:'"' | remove:"'" | strip -%}
          {%- assign p_slugs = tmp | split:',' | map:'strip' -%}

        {%- else -%}
          {%- assign tmp = p_json | remove:'"' | remove:"'" | strip -%}
          {%- assign p_slugs = tmp | split:'\n' | map:'strip' -%}
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}

    {%- assign p_slugs_norm = "" | split: "," -%}
    {%- for s in p_slugs -%}
      {%- assign s_norm = s | downcase | strip -%}
      {%- assign p_slugs_norm = p_slugs_norm | push: s_norm -%}
    {%- endfor -%}

    <!-- POST: {{ counter }} | title: {{ p.title }} | url: {{ p.url }} 
         raw authors: {{ p.authors | jsonify }} 
         parsed authors: {{ p_slugs | jsonify }} 
         parsed authors (norm): {{ p_slugs_norm | jsonify }}
    -->
  {%- endfor -%}
<!-- INSIGHT-STREAM DEBUG END -->
{%- endif -%}

{%- if filtered and filtered.size > 0 -%}
  <div class="insight-stream">
    <h2 class="stream-heading">Insight Stream</h2>

    <div class="insight-stream-grid">
      {%- for p in filtered -%}
        <article class="insight-card">
          <h3><a href="{{ p.url | relative_url }}">{{ p.title }}</a></h3>
          {%- if p.excerpt -%}
            <p class="excerpt">{{ p.excerpt }}</p>
          {%- endif -%}
          <p class="meta">{{ p.date | date: "%B %-d, %Y" }}</p>
        </article>
      {%- endfor -%}
    </div>
  </div>
{%- else -%}
  <p><em>No Insight Stream articles found.</em></p>
{%- endif -%}