{%- comment -%}
authors grid section â€” collection-only, lean version

sections:
  - type: authors
    data:
      leadership_flow:
        label: ...
        designation_type: ...
        limit: ...
{%- endcomment -%}

{%- assign D = section.data -%}
{%- assign designation_type = D.leadership_flow.designation_type | default: '' | downcase | strip -%}

{%- if D.leadership_flow and D.leadership_flow.label -%}
<section class="md-flow">
  <h2>{{ D.leadership_flow.label }}</h2>
</section>
{%- endif -%}

{%- comment -%} Normalize include.authors (slugs) to an array {%- endcomment -%}
{%- assign use_override = include.authors and include.authors != "" -%}
{%- if use_override -%}
  {%- assign raw = include.authors -%}
  {%- if raw[0] != nil -%}
    {%- assign slugs = raw -%}
  {%- elsif raw contains '[' and raw contains ']' -%}
    {%- assign tmp = raw | remove:'[' | remove:']' | remove:'"' | remove:"'" | strip -%}
    {%- assign slugs = tmp | split:',' | map:'strip' -%}
  {%- elsif raw contains ',' -%}
    {%- assign slugs = raw | split:',' | map:'strip' -%}
  {%- else -%}
    {%- assign slugs = raw | split:'\n' | map:'strip' -%}
  {%- endif -%}
  {%- assign docs = "" | split:"|" -%}
  {%- for s in slugs -%}
    {%- assign s = s | split:'.' | first | downcase | strip -%}
    {%- assign doc = site.authors | where:"slug", s | first -%}
    {%- if doc == nil -%}
      {%- comment -%} Fallback: match by derived slug from doc.name {%- endcomment -%}
      {%- for d in site.authors -%}
        {%- assign d_slug = d.slug | default: d.name | split:'.' | first | slugify -%}
        {%- if d_slug == s -%}{%- assign doc = d -%}{%- break -%}{%- endif -%}
      {%- endfor -%}
    {%- endif -%}
    {%- if doc -%}{%- assign docs = docs | push: doc -%}{%- endif -%}
  {%- endfor -%}
{%- else -%}
  {%- assign docs = site.authors -%}
{%- endif -%}

{%- comment -%} Filter by active and optional designation_type {%- endcomment -%}
{%- assign filtered = "" | split:"|" -%}
{%- for a in docs -%}
  {%- assign a_slug = a.slug | default: a.name | split:'.' | first | slugify -%}
  {%- assign show = a.active | default:true -%}
  {%- if show and designation_type != '' -%}
    {%- assign show = false -%}
    {%- assign ld = a.leadership_designations -%}
    {%- if ld and ld.size > 0 -%}
      {%- for item in ld -%}
        {%- assign t = item.type | downcase | strip -%}
        {%- assign v = item.value | default:item.key | to_s | strip -%}
        {%- if t == designation_type and v != '' and v != 'null' -%}
          {%- assign show = true -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  {%- endif -%}
  {%- if show -%}
    {%- assign filtered = filtered | push: a -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Sort: program_level DESC (via negation), then by date ASC {%- endcomment -%}
{%- assign entries = "" | split:"|" -%}
{%- for a in filtered -%}
  {%- assign a_slug = a.slug | default: a.name | split:'.' | first | slugify -%}
  {%- assign neg_program = a.program_level | times:-1 | plus:1000 | prepend:"0000" | slice:-4,4 -%}
  {%- assign bld = a.program_level_date | default:a.join_date | default:"9999-12-31" -%}
  {% capture entry %}{{ neg_program }}|{{ bld }}|{{ a_slug }}{% endcapture %}
  {%- assign entries = entries | push: entry -%}
{%- endfor -%}
{%- assign entries = entries | sort -%}

{%- if D.leadership_flow and D.leadership_flow.limit -%}
  {%- assign lim = D.leadership_flow.limit | plus:0 -%}
  {%- if lim > 0 and entries.size > lim -%}
    {%- assign entries = entries | slice:0, lim -%}
  {%- endif -%}
{%- endif -%}

<div class="md-authors">
  {%- for e in entries -%}
    {%- assign parts = e | split:'|' -%}
    {%- assign slug  = parts[2] -%}

    {%- comment -%} Resolve the doc again using slug with a filename fallback {%- endcomment -%}
    {%- assign doc = site.authors | where:"slug", slug | first -%}
    {%- if doc == nil -%}
      {%- for d in site.authors -%}
        {%- assign d_slug = d.slug | default: d.name | split:'.' | first | slugify -%}
        {%- if d_slug == slug -%}{%- assign doc = d -%}{%- break -%}{%- endif -%}
      {%- endfor -%}
    {%- endif -%}

    {%- if doc -%}
      {% include sections/author.html author=doc key=slug %}
    {%- endif -%}
  {%- endfor -%}
</div>
